<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>River Points 원화 계산기</title>
  <style>
    :root{--bg:#0f141a;--panel:#151b23;--text:#e6edf3;--muted:#9aa7b3;--accent:#4da3ff}
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:960px;margin:32px auto;padding:0 20px;position:relative}

    /* ===== 헤더: 제목 + 버튼들(가로 병렬) ===== */
    .header-bar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    h1{font-size:24px;margin:0;font-weight:800;color:var(--text)}
    .right-buttons{display:flex;gap:10px;align-items:center}

    /* 커피 버튼 + 툴팁 */
    .tip-wrap{position:relative;display:inline-block}
    .btn-coffee{
      background:linear-gradient(135deg,#ffd18d,#ffb74d);
      color:#2b1900;border:0;border-radius:999px;
      padding:10px 14px;font-weight:800;
      box-shadow:0 6px 14px rgba(255,183,77,.22);cursor:pointer;transition:.15s
    }
    .btn-coffee:hover{transform:translateY(-1px)}
    .tip{
      position:absolute;top:calc(100% + 6px);right:0;min-width:300px;max-width:80vw;
      background:var(--panel);border:1px solid #2b3441;border-radius:12px;
      padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);
      opacity:0;transform:translateY(-4px);pointer-events:none;transition:.18s;z-index:10
    }
    .tip:before{
      content:"";position:absolute;top:-7px;right:20px;width:14px;height:14px;
      background:var(--panel);border-left:1px solid #2b3441;border-top:1px solid #2b3441;transform:rotate(45deg)
    }
    .tip-row{display:flex;align-items:center;gap:8px;white-space:nowrap}
    .tip .muted{font-size:12px;color:var(--muted)}
    .tip code{
      font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;
      background:#0d1218;border:1px solid #1f2937;border-radius:8px;padding:6px 8px;color:var(--text)
    }
    .tip .copy{
      margin-left:auto;background:#1d2632;border:1px solid #2b3441;color:var(--text);
      border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer
    }
    .tip-wrap:hover .tip,.tip-wrap.open .tip{opacity:1;transform:translateY(0);pointer-events:auto}
    @media (max-width:520px){.tip{min-width:260px}}

    /* X / Telegram 버튼(브랜드 컬러) */
    .icon-btn{
      display:inline-flex;align-items:center;justify-content:center;gap:6px;
      padding:0 14px;height:40px;border-radius:999px;text-decoration:none;
      font-size:14px;font-weight:600;color:#fff;box-shadow:0 6px 14px rgba(0,0,0,.25);transition:.15s
    }
    .icon-btn:hover{transform:translateY(-1px);opacity:.95}
    .icon-btn svg{width:18px;height:18px;fill:currentColor}
    .icon-btn.x{background:#000;border:1px solid #111}
    .icon-btn.tg{background:#229ED9;border:1px solid #229ED9}

    /* 카드/입력/표시 */
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:20px;margin-bottom:16px}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:760px){.grid,.grid-3{grid-template-columns:1fr}}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="number"],input[type="text"]{width:100%;padding:12px;border-radius:12px;border:1px solid #2b3441;background:#0d1218;color:var(--text)}
    input[type="range"]{width:100%}
    button{background:var(--accent);color:#031225;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:0.2s}
    button:hover{opacity:0.9}
    button.ghost{background:transparent;border:1px solid #334155;color:var(--text)}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .kpi .box{background:#0d1218;border:1px solid #1f2937;border-radius:12px;padding:14px}
    .kpi .val{font-size:18px;font-weight:800}
    .big{font-size:28px;font-weight:900}
    iframe{width:100%;height:480px;border:0;border-radius:12px}
    .chart-toggle{display:flex;gap:8px;margin-bottom:12px}
    .chart-toggle button{flex:1;background:#1d2632;border:1px solid #2b3441;color:var(--muted)}
    .chart-toggle button.active{background:var(--accent);color:#001425;font-weight:700}

    /* 포인트 단가 미니 KPI */
    .mini-kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .mini-kpi .box{background:#0d1218;border:1px solid #1f2937;border-radius:12px;padding:14px}
    .mini-kpi .val{font-size:18px;font-weight:800}
    @media (max-width:760px){.mini-kpi{grid-template-columns:1fr}}

    /* ===== 전환률 비교 카드 ===== */
    .ratio-grid{display:grid;grid-template-columns:2fr 3fr;gap:12px}
    @media (max-width:760px){.ratio-grid{grid-template-columns:1fr}}
    .ratio-box{background:#0d1218;border:1px solid #1f2937;border-radius:12px;padding:14px}
    .ratio-num{font-size:18px;font-weight:800}
    .note-ok{color:#86efac} .note-warn{color:#fbbf24} .note-bad{color:#fca5a5}

    /* 🔁 반응형 그래프: 중앙 정렬 + 너비 clamp (320~560px) */
    .ratio-center{display:flex;justify-content:center}
    .ratio-chart-wrap{display:inline-block; max-width:100%}
    #ratioChart{
      background:#0d1218; border:1px solid #1f2937; border-radius:12px;
      display:block; /* width/height는 JS에서 설정 */
    }

    /* 범례(그래프 우측 하단 → 작은 화면에서는 가운데) */
    .legend {display:flex;gap:14px;justify-content:flex-end;align-items:center;font-size:12px;color:var(--muted);margin-top:6px;}
    .legend-item { display:flex; align-items:center; gap:6px; }
    .legend-color { width:16px; height:8px; border-radius:3px; }
    .legend-color.green { background:#22c55e; }
    .legend-color.blue  { background:#4da3ff; }
    @media (max-width:560px){.legend{ justify-content:center; }}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 헤더(제목 + 버튼 3개 가로 병렬) -->
    <div class="header-bar">
      <h1>River Points 원화 계산기</h1>
      <div class="right-buttons">
        <!-- 커피 쏘기 -->
        <div class="tip-wrap" id="coffeeWrap" aria-live="polite">
          <button class="btn-coffee" id="coffeeBtn" aria-haspopup="true" aria-expanded="false">☕︎ Vision에게 커피 쏘기</button>
          <div class="tip" id="coffeeTip" role="tooltip">
            <div class="tip-row">
              <span class="muted">지갑 주소</span>
              <code id="walletAddr">0xYourWalletAddressHere</code>
              <button class="copy" id="copyBtn" title="주소 복사">복사</button>
            </div>
          </div>
        </div>
        <!-- X -->
        <a class="icon-btn x" href="https://x.com/@Vision_Crypt0" target="_blank" rel="noopener" aria-label="X로 이동">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18.244 2H21l-6.563 7.5L22 22h-6.756l-4.74-6.21L4.9 22H2l7.07-8.08L2 2h6.756l4.4 5.777L18.244 2Zm-2.376 18h2.073L8.214 4H6.142l9.726 16Z"/></svg>
          X
        </a>
        <!-- Telegram -->
        <a class="icon-btn tg" href="https://t.me/kartrider99" target="_blank" rel="noopener" aria-label="텔레그램으로 이동">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9.03 15.22 8.86 19c.35 0 .5-.15.69-.33l1.66-1.6 3.44 2.52c.63.35 1.08.17 1.24-.58l2.25-10.57h.01c.2-.96-.35-1.34-.97-1.1L3.6 10.29c-.93.36-.92.88-.16 1.11l3.6 1.12 8.36-5.29c.39-.25.74-.11.45.16"/></svg>
          Telegram
        </a>
      </div>
    </div>

    <p class="muted">
      계산식: <code>KRW = RiverPoints × ConversionRate(일) × (River/USDT) × (KRW/USDT)</code><br>
      실시간 시세는 리버(Bitget), 테더(Upbit), 포인트(GeckoTerminal API)를 사용합니다.<br>
      $RIVER와 $River Pts 의 정보는 모두 PancakeSwap 기준입니다.
    </p>

    <!-- 수익 계산기 -->
    <div class="card">
      <div class="grid">
        <div>
          <label>보유한 River Points</label>
          <input id="points" type="number" min="0" step="0.0001" placeholder="예) 10000" />
        </div>
        <div>
          <label>스테이킹 일수 (0~180)</label>
          <input id="days" type="range" min="0" max="180" value="0" step="1" />
          <div class="muted">선택: <span id="daysOut">0</span>일 · Conversion Rate: <span id="rateOut">0.0000000</span> · vs Day1: <span id="vs1x">0x</span></div>
        </div>
      </div>

      <div class="grid-3" style="margin-top:12px">
        <div>
          <label>$RIVER / USDT (Bitget 실시간)</label>
          <input id="riverUsdt" type="text" placeholder="예: 0.1234" />
          <div class="muted" id="riverUsdtOut">-</div>
        </div>
        <div>
          <label>KRW / USDT (Upbit 실시간)</label>
          <input id="krwUsdt" type="text" placeholder="예: 1350" />
          <div class="muted" id="krwUsdtOut">-</div>
        </div>
        <div>
          <label>데이터</label>
          <button id="refreshBtn">실시간 가격 불러오기</button>
          <button class="ghost" id="clearBtn">초기화</button>
          <div class="muted" id="lastUpdated">마지막 업데이트: -</div>
        </div>
      </div>

      <div class="kpi">
        <div class="box"><div class="muted">예상 수익(USDT)</div><div class="val" id="usdtOut">-</div></div>
        <div class="box"><div class="muted">예상 수익(KRW)</div><div class="big" id="krwOut">-</div></div>
        <div class="box"><div class="muted">Day1 기준 배수</div><div class="val" id="ratioOut">-</div></div>
      </div>
    </div>

    <!-- 포인트 단가 & 보유 시가 -->
    <div class="card">
      <h3 style="margin-top:0">포인트 단가 & 내 포인트 시가</h3>
      <div class="mini-kpi">
        <div class="box">
          <div class="muted">1 RIVER Pts ≈</div>
          <div class="val" id="price-usd">- USD</div>
        </div>
        <div class="box">
          <div class="muted">1 RIVER Pts / KRW</div>
          <div class="val" id="ptPriceKrw">- 원</div>
        </div>
        <div class="box">
          <div class="muted">내 포인트 시가</div>
          <div class="val" id="ptHoldingValue">- USD / - 원</div>
        </div>
      </div>
      <p class="muted" id="ptNote">데이터 출처: GeckoTerminal(USD), Upbit(KRW/USDT)</p>
    </div>

    <!-- 🔎 전환률 비교 & 손익분기 -->
    <div class="card">
      <h3 style="margin-top:0">전환률 비교 & 손익분기점 계산</h3>
      <div class="ratio-grid">
        <div class="ratio-box">
          <div class="muted">실시간 변환률 (RIVERPTS ÷ RIVER)</div>
          <div class="ratio-num" id="ratioNow">-</div>
          <div class="muted" id="breakevenOut">손익분기 일수: -</div>
          <div class="muted" id="recommendOut">추천: -</div>
        </div>
        <div>
          <div class="ratio-center">
            <div class="ratio-chart-wrap">
              <svg id="ratioChart" aria-label="변환률 비교 차트"></svg>
            </div>
          </div>
          <div class="legend">
            <div class="legend-item">
              <div class="legend-color green"></div>
              변환률
            </div>
            <div class="legend-item">
              <div class="legend-color blue"></div>
              변환곡선
            </div>
          </div>
        </div>
      </div>
      <p class="muted" style="margin-top:8px">
        변환률 : 지금 바로 1 Pts를 RIVER로 교환해 얻을 수 있는 비율. 공식 변환곡선이 이 선을 넘는 시점이 손익분기점입니다.
      </p>
    </div>

    <!-- 차트 (GeckoTerminal 임베드) -->
    <div class="card">
      <div class="chart-toggle">
        <button id="riverBtn" class="active">RIVER / USDT</button>
        <button id="rptsBtn">RIVER Pts / USDT</button>
      </div>
      <div id="chartContainer">
        <iframe id="chartFrame" src="" allowfullscreen></iframe>
      </div>
    </div>

    <p class="muted">River Points Calculator — 2025 Vision</p>
  </div>

  <script>
    /* =======================
       상수 & 유틸
    ======================= */
    const TOKEN_RIVER = "0xda7ad9dea9397cffddae2f8a052b82f1484252b3"; // RIVER (BSC)
    const TOKEN_RPTS  = "0xfc6be825925b7a83d131e33b46efef9084f0e014"; // RIVERPTS (BSC)

    // 가격 API
    const BITGET_URL = "https://api.bitget.com/api/v2/spot/market/tickers?symbol=RIVERUSDT"; // RIVER/USDT
    const UPBIT_URL  = "https://api.upbit.com/v1/ticker?markets=KRW-USDT";                   // KRW/USDT

    // GeckoTerminal Token/Pools API (키 불필요)
    const GECKO_TOKEN_URL = (addr)=>`https://api.geckoterminal.com/api/v2/networks/bsc/tokens/${addr}`;
    const GECKO_POOLS_URL = (addr)=>`https://api.geckoterminal.com/api/v2/networks/bsc/tokens/${addr}/pools?include=base_token,quote_token&page=1`;
    const GECKO_POOL_IFRAME = (poolAddr)=>`https://www.geckoterminal.com/bsc/pools/${poolAddr}?embed=1&info=0&swaps=0`;

    const fmt=(n,d=2)=>isNaN(n)?"-":Number(n).toLocaleString('ko-KR',{maximumFractionDigits:d});
    const nowStr=()=>new Date().toLocaleString('ko-KR');

    // Conversion Rate (0~90 선형 0→0.01, 90~180 선형 0.01→0.03)
    function convRate(days){
      const d=Math.max(0,Math.min(180,Number(days)||0));
      if(d===0)return 0;
      if(d<=90)return(d/90)*0.01;
      return 0.01+((d-90)/90)*0.02;
    }
    // 역함수: 목표 변환률 r에 도달하는 최소 일수 d (0~180)
    function invConvDays(r){
      if(r<=0) return 0;
      if(r<=0.01) return Math.min(9000*r, 180);
      if(r<=0.03) return Math.min(90 + 4500*(r-0.01), 180);
      return Infinity; // 180일 내 불가
    }
    const DAY1_RATE=convRate(1);

    /* =======================
       DOM
    ======================= */
    const $points=document.getElementById('points');
    const $days=document.getElementById('days');
    const $daysOut=document.getElementById('daysOut');
    const $rateOut=document.getElementById('rateOut');
    const $riverUsdt=document.getElementById('riverUsdt');
    const $krwUsdt=document.getElementById('krwUsdt');
    const $riverUsdtOut=document.getElementById('riverUsdtOut');
    const $krwUsdtOut=document.getElementById('krwUsdtOut');
    const $refreshBtn=document.getElementById('refreshBtn');
    const $clearBtn=document.getElementById('clearBtn');
    const $lastUpdated=document.getElementById('lastUpdated');
    const $usdtOut=document.getElementById('usdtOut');
    const $krwOut=document.getElementById('krwOut');
    const $ratioOut=document.getElementById('ratioOut');
    const $vs1x=document.getElementById('vs1x');

    const priceUsdElement = document.getElementById('price-usd');
    const $ptPriceKrw = document.getElementById('ptPriceKrw');
    const $ptHoldingValue = document.getElementById('ptHoldingValue');
    const $ptNote = document.getElementById('ptNote');

    const riverBtn=document.getElementById('riverBtn');
    const rptsBtn=document.getElementById('rptsBtn');
    const chartFrame=document.getElementById('chartFrame');

    // 새 섹션 DOM
    const $ratioNow = document.getElementById('ratioNow');
    const $breakevenOut = document.getElementById('breakevenOut');
    const $recommendOut = document.getElementById('recommendOut');
    const $ratioChart = document.getElementById('ratioChart');

    /* =======================
       상태
    ======================= */
    let state={ riverUsdt:null, krwUsdt:null, rptsUsd:null };

    /* =======================
       계산 & 렌더
    ======================= */
    function recalc(){
      const pts=Number($points.value||0);
      const d=Number($days.value||0);
      const r=convRate(d);
      const riverUsdt=Number($riverUsdt.value);
      const krwUsdt=Number($krwUsdt.value);

      const usdt=pts*r*riverUsdt;
      const krw=usdt*krwUsdt;
      const ratio=DAY1_RATE?(r/DAY1_RATE):0;

      $daysOut.textContent=d.toFixed(0);
      $rateOut.textContent=r.toFixed(6);
      $vs1x.textContent=(ratio?ratio.toFixed(0):0)+"x";
      $usdtOut.textContent=fmt(usdt,4)+" USDT";
      $krwOut.textContent=fmt(krw,0)+" 원";
      $ratioOut.textContent=ratio?ratio.toFixed(0)+"x":"-";

      renderRptsSection();
      renderRatioCompare(); // ★ 새 섹션 업데이트
    }

    function renderRptsSection(){
      const rptsUsd = Number(state.rptsUsd||0);
      const fx = Number($krwUsdt.value || state.krwUsdt || 0);
      const pts = Number($points.value||0);

      if(rptsUsd>0){
        priceUsdElement.innerHTML = `1 RIVER Pts ≈ <strong>$${fmt(rptsUsd,8)}</strong>`;
        if(fx>0){
          const perKrw = rptsUsd * fx;
          $ptPriceKrw.textContent = `${fmt(perKrw,0)} 원`;
          const totalUsd = rptsUsd * pts;
          const totalKrw = perKrw * pts;
          $ptHoldingValue.textContent = `${fmt(totalUsd,4)} USD / ${fmt(totalKrw,0)} 원`;
        }else{
          $ptPriceKrw.textContent = "- 원";
          $ptHoldingValue.textContent = `${fmt(rptsUsd*pts,4)} USD / - 원`;
        }
      }else{
        priceUsdElement.textContent = "- USD";
        $ptPriceKrw.textContent = "- 원";
        $ptHoldingValue.textContent = "- USD / - 원";
      }
    }

    // ===== 변환률 비교 섹션 =====
    function renderRatioCompare(){
      const rptsUsd = Number(state.rptsUsd||0);
      const riverUsdt = Number(state.riverUsdt||$riverUsdt.value||0);

      if(!(rptsUsd>0 && riverUsdt>0)){
        $ratioNow.textContent = "-";
        $breakevenOut.textContent = "손익분기 일수: (가격 데이터 대기)";
        $recommendOut.textContent = "추천: 실시간 시세를 먼저 불러오세요.";
        drawRatioChart(null);
        return;
      }

      // 목표 변환률 = (RIVERPTS 가격) / (RIVER 가격)
      const targetRate = rptsUsd / riverUsdt;
      $ratioNow.textContent = targetRate.toFixed(6) + " (현재)";

      // 180일 내 손익분기 일수 계산
      const dNeeded = invConvDays(targetRate);
      if(!isFinite(dNeeded)){
        $breakevenOut.innerHTML = `손익분기 일수: <span class="note-bad">180일 내 도달 불가 (목표 변환률이 0.03 초과)</span>`;
        $recommendOut.textContent = "추천: 즉시 매도(또는 포인트 가격 하락/리버 가격 상승을 기다리기)";
        drawRatioChart(targetRate);
        return;
      }

      const dInt = Math.ceil(dNeeded);
      const projRate = convRate(dInt);
      const gapPct = ((projRate - targetRate) / targetRate) * 100;

      $breakevenOut.innerHTML =
        `손익분기 일수: <b>${dInt}</b>일 (공식 변환률 ${projRate.toFixed(6)})`;

      if (gapPct >= 1) {
        $recommendOut.innerHTML = `<span class="note-ok">추천: 약 ${dInt}일 이후 전환 시 유리 (목표 대비 +${gapPct.toFixed(1)}%)</span>`;
      } else if (gapPct >= 0) {
        $recommendOut.innerHTML = `<span class="note-warn">추천: 약 ${dInt}일 이후 전환 (손익분기 부근)</span>`;
      } else {
        $recommendOut.innerHTML = `<span class="note-bad">추천: 현재는 즉시 매도 편이 유리 (목표 대비 ${gapPct.toFixed(1)}%)</span>`;
      }

      drawRatioChart(targetRate, dInt);
    }

    /* ===== 반응형 차트: 손익분기일(dMark)에 따라 너비가 점진적으로 증가 ===== */
function getChartSize(wrapperEl, dMark){
  // 필요시 이하 값만 조절하면 UX를 쉽게 튜닝 가능
  const MIN_W = 400;   // 시작 최소폭 (모바일에서도 보기 좋은 크기)
  const MAX_W = 720;   // 데스크톱에서의 최대폭 (너무 크게 느껴지면 640/680 등으로)
  const avail = Math.max(0, Math.floor(wrapperEl.clientWidth || 0));

  // 컨테이너가 허용하는 최대치(스크롤 없이 들어갈 수 있는 한도)
  const CAP = Math.max(MIN_W, Math.min(avail, MAX_W));

  // 기본은 최소폭으로 고정
  let W = MIN_W;

  // dMark가 유효해지면(=그래프가 오른쪽으로 "이동"했다고 볼 수 있을 때) 점차 확대
  if (typeof dMark === "number" && isFinite(dMark)) {
    // 0일 → 0, 180일 → 1
    const t = Math.max(0, Math.min(1, dMark / 180));
    // 선형 보간: dMark가 클수록 MIN_W → MAX_W로 넓어짐
    const desired = MIN_W + (MAX_W - MIN_W) * t;
    W = Math.min(CAP, desired);
  }

  // 가독성 위해 폭에 따라 높이도 살짝 조정
  const H = (W <= 480) ? 220 : 260;
  return { W, H };
}

function drawRatioChart(target=null, dMark=null){
  const svg = $ratioChart;
  const wrap = svg.parentElement; // .ratio-chart-wrap
  const { W, H } = getChartSize(wrap, dMark);

  svg.setAttribute("width", W);
  svg.setAttribute("height", H);
  svg.removeAttribute("viewBox"); // 비율 스케일 방지
  svg.innerHTML = "";

  const pad = 28;
  const x0 = pad, y0 = H - pad, x1 = W - pad, y1 = pad;
  const maxX = 180, maxY = 0.03;
  const X = d=> x0 + (d/maxX)*(x1-x0);
  const Y = r=> y0 - (r/maxY)*(y0-y1);

  // 배경 눈금 (Y)
  for (let r=0; r<=maxY+1e-9; r+=0.005){
    const y = Y(r);
    svg.insertAdjacentHTML("beforeend", `<line x1="${x0}" y1="${y}" x2="${x1}" y2="${y}" stroke="rgba(255,255,255,.06)" />`);
    svg.insertAdjacentHTML("beforeend", `<text x="${x0-6}" y="${y+4}" fill="#9aa7b3" font-size="10" text-anchor="end">${r.toFixed(3)}</text>`);
  }
  // X축 눈금
  for (let d=0; d<=180; d+=30){
    const x = X(d);
    svg.insertAdjacentHTML("beforeend", `<line x1="${x}" y1="${y0}" x2="${x}" y2="${y1}" stroke="rgba(255,255,255,.04)" />`);
    svg.insertAdjacentHTML("beforeend", `<text x="${x}" y="${y0+14}" fill="#9aa7b3" font-size="10" text-anchor="middle">${d}</text>`);
  }

  // 공식 변환률 곡선 (파랑)
  const pathPts = [];
  for (let d=0; d<=180; d++){
    pathPts.push(`${X(d)},${Y(convRate(d))}`);
  }
  svg.insertAdjacentHTML("beforeend", `<polyline points="${pathPts.join(" ")}" fill="none" stroke="#4da3ff" stroke-width="2"/>`);

  // 목표선 (초록)
  if (typeof target === "number"){
    const yT = Y(target);
    svg.insertAdjacentHTML("beforeend", `<line x1="${x0}" y1="${yT}" x2="${x1}" y2="${yT}" stroke="#22c55e" stroke-dasharray="6,4" stroke-width="2"/>`);
  }

  // 교차점 표시
  if (typeof dMark === "number" && isFinite(dMark)){
    const xM = X(dMark), yM = Y(convRate(dMark));
    svg.insertAdjacentHTML("beforeend", `<line x1="${xM}" y1="${y0}" x2="${xM}" y2="${y1}" stroke="rgba(255,255,255,.15)" stroke-dasharray="4,4"/>`);
    svg.insertAdjacentHTML("beforeend", `<circle cx="${xM}" cy="${yM}" r="4" fill="#22c55e" stroke="#064e3b"/>`);
    svg.insertAdjacentHTML("beforeend", `<text x="${xM+6}" y="${yM-6}" fill="#22c55e" font-size="11">~${Math.ceil(dMark)}일</text>`);
  }

  // 축
  svg.insertAdjacentHTML("beforeend", `<line x1="${x0}" y1="${y0}" x2="${x1}" y2="${y0}" stroke="#334155"/>`);
  svg.insertAdjacentHTML("beforeend", `<line x1="${x0}" y1="${y0}" x2="${x0}" y2="${y1}" stroke="#334155"/>`);
  svg.insertAdjacentHTML("beforeend", `<text x="${x1}" y="${y0+20}" fill="#9aa7b3" font-size="10" text-anchor="end">일</text>`);
  svg.insertAdjacentHTML("beforeend", `<text x="${x0-18}" y="${y1}" fill="#9aa7b3" font-size="10" text-anchor="start">변환률</text>`);
}

    /* =======================
       Fetchers
    ======================= */
    async function fetchRiverUsdt(){
      try{
        const j=await fetch("https://api.bitget.com/api/v2/spot/market/tickers?symbol=RIVERUSDT",{cache:"no-store"}).then(r=>r.json());
        const price=parseFloat(j?.data?.[0]?.lastPr);
        if(isFinite(price)){
          state.riverUsdt=price;
          $riverUsdt.value=String(price);
          $riverUsdtOut.textContent=`현재 RIVER/USDT: ${fmt(price,6)} (Bitget)`;
        } else {
          $riverUsdtOut.textContent="자동 조회 실패 — 직접 입력";
        }
      }catch(e){console.warn(e);$riverUsdtOut.textContent="자동 조회 실패 — 직접 입력";}
    }

    async function fetchKrwPerUsdt(){
      try{
        const j=await fetch("https://api.upbit.com/v1/ticker?markets=KRW-USDT",{cache:"no-store"}).then(r=>r.json());
        const price=j?.[0]?.trade_price;
        if(typeof price==="number"){
          state.krwUsdt=price;
          $krwUsdt.value=String(price);
          $krwUsdtOut.textContent=`현재 KRW/USDT: ${fmt(price,2)} ₩/USDT (Upbit)`;
        } else {
          $krwUsdtOut.textContent="자동 조회 실패 — 직접 입력";
        }
      }catch(e){console.warn(e);$krwUsdtOut.textContent="자동 조회 실패 — 직접 입력";}
    }

    // GeckoTerminal: RIVERPTS USD 가격
    async function fetchRptsUsdFromGecko(){
      try{
        const res = await fetch(GECKO_TOKEN_URL(TOKEN_RPTS), {cache:"no-store"});
        if(!res.ok) throw new Error("Gecko token api "+res.status);
        const j = await res.json();
        const usd = parseFloat(j?.data?.attributes?.price_usd);
        if(isFinite(usd)){
          state.rptsUsd = usd;
          $ptNote.textContent = "데이터 출처: GeckoTerminal(USD), Upbit(KRW/USDT)";
        }else{
          state.rptsUsd = null;
        }
      }catch(e){
        console.warn("GeckoTerminal token price 실패:", e);
        state.rptsUsd = null;
      }
    }

    // GeckoTerminal: 토큰의 주요 풀 선택 (USDT/BUSD 우선 → 유동성 최대)
    async function pickBestGeckoPool(tokenAddr){
      const res = await fetch(GECKO_POOLS_URL(tokenAddr), {cache:"no-store"});
      if(!res.ok) throw new Error("Gecko pools api "+res.status);
      const j = await res.json();
      const pools = Array.isArray(j?.data) ? j.data : [];
      if(!pools.length) throw new Error("no pools");

      const withMeta = pools.map(p => {
        const base = j?.included?.find(i => i.id === p?.relationships?.base_token?.data?.id);
        const quote = j?.included?.find(i => i.id === p?.relationships?.quote_token?.data?.id);
        return { address:p?.attributes?.address, base, quote, raw:p };
      });

      let target = withMeta.find(p => (p?.quote?.attributes?.symbol||"").toUpperCase()==="USDT")
               || withMeta.find(p => (p?.quote?.attributes?.symbol||"").toUpperCase()==="BUSD");

      if(!target){
        target = withMeta.slice().sort((a,b)=>{
          const av = Number(a?.raw?.attributes?.reserve_in_usd||0);
          const bv = Number(b?.raw?.attributes?.reserve_in_usd||0);
          return bv-av;
        })[0];
      }
      if(!target?.address) throw new Error("no pool address");
      return target.address;
    }

    async function refreshAll(){
      $lastUpdated.textContent="업데이트 중…";
      await Promise.all([fetchRiverUsdt(), fetchKrwPerUsdt(), fetchRptsUsdFromGecko()]);
      $lastUpdated.textContent="마지막 업데이트: "+nowStr();
      recalc();
    }

    /* =======================
       차트 전환 (GeckoTerminal 임베드)
    ======================= */
    function setActive(on, off){ on.classList.add('active'); off.classList.remove('active'); }

    async function loadChartForToken(tokenAddr){
      try{
        const pool = await pickBestGeckoPool(tokenAddr);
        chartFrame.src = GECKO_POOL_IFRAME(pool);
      }catch(e){
        console.warn("차트 로드 실패:", e);
        chartFrame.src = `https://www.geckoterminal.com/bsc/tokens/${tokenAddr}?embed=1`;
      }
    }

    riverBtn.onclick = ()=>{ setActive(riverBtn, rptsBtn); loadChartForToken(TOKEN_RIVER); };
    rptsBtn.onclick  = ()=>{ setActive(rptsBtn, riverBtn); loadChartForToken(TOKEN_RPTS); };

    /* =======================
       초기 실행 + 리사이즈 대응
    ======================= */
    [$points,$days,$riverUsdt,$krwUsdt].forEach($el=>{
      $el.addEventListener('input', recalc);
      $el.addEventListener('change', recalc);
    });
    document.getElementById('refreshBtn').addEventListener('click', refreshAll);
    document.getElementById('clearBtn').addEventListener('click', ()=>{
      $points.value=""; $days.value=0; $riverUsdt.value=""; $krwUsdt.value="";
      $riverUsdtOut.textContent="-"; $krwUsdtOut.textContent="-"; $lastUpdated.textContent="마지막 업데이트: -";
      recalc();
    });

    (async () => {
      await refreshAll();
      await loadChartForToken(TOKEN_RIVER);
    })();

    // 창 리사이즈/회전에 맞춰 차트 재그리기 (디바운스)
    let _rrf=null;
    window.addEventListener('resize', ()=>{
      if(_rrf) cancelAnimationFrame(_rrf);
      _rrf = requestAnimationFrame(()=> renderRatioCompare());
    });
    // 컨테이너 실제 폭 변화 감지 (더 정밀)
    new ResizeObserver(()=> renderRatioCompare())
      .observe(document.querySelector('.ratio-chart-wrap'));
  </script>

  <!-- ☕︎ 커피 버튼: 호버 끊김 방지(지연 닫힘) + 복사 -->
  <script>
    const WALLET_ADDRESS = "0x6D4dA73e9780FaCe848305961e49D19d310239d1";
    const coffeeWrap = document.getElementById("coffeeWrap");
    const coffeeBtn  = document.getElementById("coffeeBtn");
    const walletAddr = document.getElementById("walletAddr");
    const copyBtn    = document.getElementById("copyBtn");
    walletAddr.textContent = WALLET_ADDRESS;

    let tipOpen=false, closeTimer=null;
    function openTip(){ clearTimeout(closeTimer); tipOpen=true; coffeeWrap.classList.add("open"); coffeeBtn.setAttribute("aria-expanded","true"); }
    function closeTip(){ closeTimer=setTimeout(()=>{ tipOpen=false; coffeeWrap.classList.remove("open"); coffeeBtn.setAttribute("aria-expanded","false"); },120); }

    coffeeWrap.addEventListener("mouseenter", openTip);
    coffeeWrap.addEventListener("mouseleave", closeTip);
    coffeeBtn.addEventListener("click", (e)=>{ e.preventDefault(); tipOpen?closeTip():openTip(); });
    document.addEventListener("click", (e)=>{ if(!coffeeWrap.contains(e.target) && tipOpen) closeTip(); });

    copyBtn.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(WALLET_ADDRESS);
        const old=copyBtn.textContent; copyBtn.textContent="복사됨!";
        setTimeout(()=>copyBtn.textContent=old,1200);
      }catch(e){
        const r=document.createRange(); r.selectNodeContents(walletAddr);
        const s=window.getSelection(); s.removeAllRanges(); s.addRange(r);
        alert("클립보드 권한이 차단되어 주소를 선택했어요. 복사(Ctrl/Cmd+C) 해주세요.");
      }
    });
  </script>
</body>
</html>
