<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>River Points ì›í™” ê³„ì‚°ê¸°</title>
  <style>
    :root{--bg:#0f141a;--panel:#151b23;--text:#e6edf3;--muted:#9aa7b3;--accent:#4da3ff}
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:960px;margin:32px auto;padding:0 20px;position:relative}

    /* ===== í—¤ë”: ì œëª© + ë²„íŠ¼ë“¤(ê°€ë¡œ ë³‘ë ¬) ===== */
    .header-bar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    h1{font-size:24px;margin:0;font-weight:800;color:var(--text)}
    .right-buttons{display:flex;gap:10px;align-items:center}

    /* ì»¤í”¼ ë²„íŠ¼ + íˆ´íŒ */
    .tip-wrap{position:relative;display:inline-block}
    .btn-coffee{
      background:linear-gradient(135deg,#ffd18d,#ffb74d);
      color:#2b1900;border:0;border-radius:999px;
      padding:10px 14px;font-weight:800;
      box-shadow:0 6px 14px rgba(255,183,77,.22);cursor:pointer;transition:.15s
    }
    .btn-coffee:hover{transform:translateY(-1px)}
    .tip{
      position:absolute;top:calc(100% + 6px);right:0;min-width:300px;max-width:80vw;
      background:var(--panel);border:1px solid #2b3441;border-radius:12px;
      padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);
      opacity:0;transform:translateY(-4px);pointer-events:none;transition:.18s;z-index:10
    }
    .tip:before{
      content:"";position:absolute;top:-7px;right:20px;width:14px;height:14px;
      background:var(--panel);border-left:1px solid #2b3441;border-top:1px solid #2b3441;transform:rotate(45deg)
    }
    .tip-row{display:flex;align-items:center;gap:8px;white-space:nowrap}
    .tip .muted{font-size:12px;color:var(--muted)}
    .tip code{
      font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;
      background:#0d1218;border:1px solid #1f2937;border-radius:8px;padding:6px 8px;color:var(--text)
    }
    .tip .copy{
      margin-left:auto;background:#1d2632;border:1px solid #2b3441;color:var(--text);
      border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer
    }
    .tip-wrap:hover .tip,.tip-wrap.open .tip{opacity:1;transform:translateY(0);pointer-events:auto}
    @media (max-width:520px){.tip{min-width:260px}}

    /* X / Telegram ë²„íŠ¼(ë¸Œëœë“œ ì»¬ëŸ¬) */
    .icon-btn{
      display:inline-flex;align-items:center;justify-content:center;gap:6px;
      padding:0 14px;height:40px;border-radius:999px;text-decoration:none;
      font-size:14px;font-weight:600;color:#fff;box-shadow:0 6px 14px rgba(0,0,0,.25);transition:.15s
    }
    .icon-btn:hover{transform:translateY(-1px);opacity:.95}
    .icon-btn svg{width:18px;height:18px;fill:currentColor}
    .icon-btn.x{background:#000;border:1px solid #111}
    .icon-btn.tg{background:#229ED9;border:1px solid #229ED9}

    /* ì¹´ë“œ/ì…ë ¥/í‘œì‹œ */
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:20px;margin-bottom:16px}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:760px){.grid,.grid-3{grid-template-columns:1fr}}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="number"],input[type="text"]{width:100%;padding:12px;border-radius:12px;border:1px solid #2b3441;background:#0d1218;color:var(--text)}
    input[type="range"]{width:100%}
    button{background:var(--accent);color:#031225;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:0.2s}
    button:hover{opacity:0.9}
    button.ghost{background:transparent;border:1px solid #334155;color:var(--text)}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .kpi .box{background:#0d1218;border:1px solid #1f2937;border-radius:12px;padding:14px}
    .kpi .val{font-size:18px;font-weight:800}
    .big{font-size:28px;font-weight:900}
    iframe{width:100%;height:480px;border:0;border-radius:12px}
    .chart-toggle{display:flex;gap:8px;margin-bottom:12px}
    .chart-toggle button{flex:1;background:#1d2632;border:1px solid #2b3441;color:var(--muted)}
    .chart-toggle button.active{background:var(--accent);color:#001425;font-weight:700}

    /* í¬ì¸íŠ¸ ë‹¨ê°€ ë¯¸ë‹ˆ KPI */
    .mini-kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .mini-kpi .box{background:#0d1218;border:1px solid #1f2937;border-radius:12px;padding:14px}
    .mini-kpi .val{font-size:18px;font-weight:800}
    @media (max-width:760px){.mini-kpi{grid-template-columns:1fr}}

    /* ===== ì „í™˜ë¥  ë¹„êµ ì¹´ë“œ ===== */
    .ratio-grid{display:grid;grid-template-columns:2fr 3fr;gap:12px}
    @media (max-width:760px){.ratio-grid{grid-template-columns:1fr}}
    .ratio-box{background:#0d1218;border:1px solid #1f2937;border-radius:12px;padding:14px}
    .ratio-num{font-size:18px;font-weight:800}
    .note-ok{color:#86efac} .note-warn{color:#fbbf24} .note-bad{color:#fca5a5}

    /* ğŸ” ë°˜ì‘í˜• ê·¸ë˜í”„: ì¤‘ì•™ ì •ë ¬ + ë„ˆë¹„ clamp (320~560px) */
    .ratio-center{display:flex;justify-content:center}
    .ratio-chart-wrap{display:inline-block; max-width:100%}
    #ratioChart{
      background:#0d1218; border:1px solid #1f2937; border-radius:12px;
      display:block; /* width/heightëŠ” JSì—ì„œ ì„¤ì • */
    }

    /* ë²”ë¡€(ê·¸ë˜í”„ ìš°ì¸¡ í•˜ë‹¨ â†’ ì‘ì€ í™”ë©´ì—ì„œëŠ” ê°€ìš´ë°) */
    .legend {display:flex;gap:14px;justify-content:flex-end;align-items:center;font-size:12px;color:var(--muted);margin-top:6px;}
    .legend-item { display:flex; align-items:center; gap:6px; }
    .legend-color { width:16px; height:8px; border-radius:3px; }
    .legend-color.green { background:#22c55e; }
    .legend-color.blue  { background:#4da3ff; }
    @media (max-width:560px){.legend{ justify-content:center; }}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- í—¤ë”(ì œëª© + ë²„íŠ¼ 3ê°œ ê°€ë¡œ ë³‘ë ¬) -->
    <div class="header-bar">
      <h1>River Points ì›í™” ê³„ì‚°ê¸°</h1>
      <div class="right-buttons">
        <!-- ì»¤í”¼ ì˜ê¸° -->
        <div class="tip-wrap" id="coffeeWrap" aria-live="polite">
          <button class="btn-coffee" id="coffeeBtn" aria-haspopup="true" aria-expanded="false">â˜•ï¸ Visionì—ê²Œ ì»¤í”¼ ì˜ê¸°</button>
          <div class="tip" id="coffeeTip" role="tooltip">
            <div class="tip-row">
              <span class="muted">ì§€ê°‘ ì£¼ì†Œ</span>
              <code id="walletAddr">0xYourWalletAddressHere</code>
              <button class="copy" id="copyBtn" title="ì£¼ì†Œ ë³µì‚¬">ë³µì‚¬</button>
            </div>
          </div>
        </div>
        <!-- X -->
        <a class="icon-btn x" href="https://x.com/@Vision_Crypt0" target="_blank" rel="noopener" aria-label="Xë¡œ ì´ë™">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18.244 2H21l-6.563 7.5L22 22h-6.756l-4.74-6.21L4.9 22H2l7.07-8.08L2 2h6.756l4.4 5.777L18.244 2Zm-2.376 18h2.073L8.214 4H6.142l9.726 16Z"/></svg>
          X
        </a>
        <!-- Telegram -->
        <a class="icon-btn tg" href="https://t.me/kartrider99" target="_blank" rel="noopener" aria-label="í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì´ë™">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9.03 15.22 8.86 19c.35 0 .5-.15.69-.33l1.66-1.6 3.44 2.52c.63.35 1.08.17 1.24-.58l2.25-10.57h.01c.2-.96-.35-1.34-.97-1.1L3.6 10.29c-.93.36-.92.88-.16 1.11l3.6 1.12 8.36-5.29c.39-.25.74-.11.45.16"/></svg>
          Telegram
        </a>
      </div>
    </div>

    <p class="muted">
      ê³„ì‚°ì‹: <code>KRW = RiverPoints Ã— ConversionRate(ì¼) Ã— (River/USDT) Ã— (KRW/USDT)</code><br>
      ì‹¤ì‹œê°„ ì‹œì„¸ëŠ” ë¦¬ë²„(Bitget), í…Œë”(Upbit), í¬ì¸íŠ¸(GeckoTerminal API)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.<br>
      $RIVERì™€ $River Pts ì˜ ì •ë³´ëŠ” ëª¨ë‘ PancakeSwap ê¸°ì¤€ì…ë‹ˆë‹¤.
    </p>

    <!-- ìˆ˜ìµ ê³„ì‚°ê¸° -->
    <div class="card">
      <div class="grid">
        <div>
          <label>ë³´ìœ í•œ River Points</label>
          <input id="points" type="number" min="0" step="0.0001" placeholder="ì˜ˆ) 10000" />
        </div>
        <div>
          <label>ìŠ¤í…Œì´í‚¹ ì¼ìˆ˜ (0~180)</label>
          <input id="days" type="range" min="0" max="180" value="0" step="1" />
          <div class="muted">ì„ íƒ: <span id="daysOut">0</span>ì¼ Â· Conversion Rate: <span id="rateOut">0.0000000</span> Â· vs Day1: <span id="vs1x">0x</span></div>
        </div>
      </div>

      <div class="grid-3" style="margin-top:12px">
        <div>
          <label>$RIVER / USDT (Bitget ì‹¤ì‹œê°„)</label>
          <input id="riverUsdt" type="text" placeholder="ì˜ˆ: 0.1234" />
          <div class="muted" id="riverUsdtOut">-</div>
        </div>
        <div>
          <label>KRW / USDT (Upbit ì‹¤ì‹œê°„)</label>
          <input id="krwUsdt" type="text" placeholder="ì˜ˆ: 1350" />
          <div class="muted" id="krwUsdtOut">-</div>
        </div>
        <div>
          <label>ë°ì´í„°</label>
          <button id="refreshBtn">ì‹¤ì‹œê°„ ê°€ê²© ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button class="ghost" id="clearBtn">ì´ˆê¸°í™”</button>
          <div class="muted" id="lastUpdated">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</div>
        </div>
      </div>

      <div class="kpi">
        <div class="box"><div class="muted">ì˜ˆìƒ ìˆ˜ìµ(USDT)</div><div class="val" id="usdtOut">-</div></div>
        <div class="box"><div class="muted">ì˜ˆìƒ ìˆ˜ìµ(KRW)</div><div class="big" id="krwOut">-</div></div>
        <div class="box"><div class="muted">Day1 ê¸°ì¤€ ë°°ìˆ˜</div><div class="val" id="ratioOut">-</div></div>
      </div>
    </div>

    <!-- í¬ì¸íŠ¸ ë‹¨ê°€ & ë³´ìœ  ì‹œê°€ -->
    <div class="card">
      <h3 style="margin-top:0">í¬ì¸íŠ¸ ë‹¨ê°€ & ë‚´ í¬ì¸íŠ¸ ì‹œê°€</h3>
      <div class="mini-kpi">
        <div class="box">
          <div class="muted">1 RIVER Pts â‰ˆ</div>
          <div class="val" id="price-usd">- USD</div>
        </div>
        <div class="box">
          <div class="muted">1 RIVER Pts / KRW</div>
          <div class="val" id="ptPriceKrw">- ì›</div>
        </div>
        <div class="box">
          <div class="muted">ë‚´ í¬ì¸íŠ¸ ì‹œê°€</div>
          <div class="val" id="ptHoldingValue">- USD / - ì›</div>
        </div>
      </div>
      <p class="muted" id="ptNote">ë°ì´í„° ì¶œì²˜: GeckoTerminal(USD), Upbit(KRW/USDT)</p>
    </div>

    <!-- ğŸ” ì „í™˜ë¥  ë¹„êµ & ì†ìµë¶„ê¸° -->
    <div class="card">
      <h3 style="margin-top:0">ì „í™˜ë¥  ë¹„êµ & ì†ìµë¶„ê¸°ì  ê³„ì‚°</h3>
      <div class="ratio-grid">
        <div class="ratio-box">
          <div class="muted">ì‹¤ì‹œê°„ ë³€í™˜ë¥  (RIVERPTS Ã· RIVER)</div>
          <div class="ratio-num" id="ratioNow">-</div>
          <div class="muted" id="breakevenOut">ì†ìµë¶„ê¸° ì¼ìˆ˜: -</div>
          <div class="muted" id="recommendOut">ì¶”ì²œ: -</div>
        </div>
        <div>
          <div class="ratio-center">
            <div class="ratio-chart-wrap">
              <svg id="ratioChart" aria-label="ë³€í™˜ë¥  ë¹„êµ ì°¨íŠ¸"></svg>
            </div>
          </div>
          <div class="legend">
            <div class="legend-item">
              <div class="legend-color green"></div>
              ë³€í™˜ë¥ 
            </div>
            <div class="legend-item">
              <div class="legend-color blue"></div>
              ë³€í™˜ê³¡ì„ 
            </div>
          </div>
        </div>
      </div>
      <p class="muted" style="margin-top:8px">
        ë³€í™˜ë¥  : ì§€ê¸ˆ ë°”ë¡œ 1 Ptsë¥¼ RIVERë¡œ êµí™˜í•´ ì–»ì„ ìˆ˜ ìˆëŠ” ë¹„ìœ¨. ê³µì‹ ë³€í™˜ê³¡ì„ ì´ ì´ ì„ ì„ ë„˜ëŠ” ì‹œì ì´ ì†ìµë¶„ê¸°ì ì…ë‹ˆë‹¤.
      </p>
    </div>

    <!-- ì°¨íŠ¸ (GeckoTerminal ì„ë² ë“œ) -->
    <div class="card">
      <div class="chart-toggle">
        <button id="riverBtn" class="active">RIVER / USDT</button>
        <button id="rptsBtn">RIVER Pts / USDT</button>
      </div>
      <div id="chartContainer">
        <iframe id="chartFrame" src="" allowfullscreen></iframe>
      </div>
    </div>

    <p class="muted">River Points Calculator â€” 2025 Vision</p>
  </div>

  <script>
    /* =======================
       ìƒìˆ˜ & ìœ í‹¸
    ======================= */
    const TOKEN_RIVER = "0xda7ad9dea9397cffddae2f8a052b82f1484252b3"; // RIVER (BSC)
    const TOKEN_RPTS  = "0xfc6be825925b7a83d131e33b46efef9084f0e014"; // RIVERPTS (BSC)

    // ê°€ê²© API
    const BITGET_URL = "https://api.bitget.com/api/v2/spot/market/tickers?symbol=RIVERUSDT"; // RIVER/USDT
    const UPBIT_URL  = "https://api.upbit.com/v1/ticker?markets=KRW-USDT";                   // KRW/USDT

    // GeckoTerminal Token/Pools API (í‚¤ ë¶ˆí•„ìš”)
    const GECKO_TOKEN_URL = (addr)=>`https://api.geckoterminal.com/api/v2/networks/bsc/tokens/${addr}`;
    const GECKO_POOLS_URL = (addr)=>`https://api.geckoterminal.com/api/v2/networks/bsc/tokens/${addr}/pools?include=base_token,quote_token&page=1`;
    const GECKO_POOL_IFRAME = (poolAddr)=>`https://www.geckoterminal.com/bsc/pools/${poolAddr}?embed=1&info=0&swaps=0`;

    const fmt=(n,d=2)=>isNaN(n)?"-":Number(n).toLocaleString('ko-KR',{maximumFractionDigits:d});
    const nowStr=()=>new Date().toLocaleString('ko-KR');

    // Conversion Rate (0~90 ì„ í˜• 0â†’0.01, 90~180 ì„ í˜• 0.01â†’0.03)
    function convRate(days){
      const d=Math.max(0,Math.min(180,Number(days)||0));
      if(d===0)return 0;
      if(d<=90)return(d/90)*0.01;
      return 0.01+((d-90)/90)*0.02;
    }
    // ì—­í•¨ìˆ˜: ëª©í‘œ ë³€í™˜ë¥  rì— ë„ë‹¬í•˜ëŠ” ìµœì†Œ ì¼ìˆ˜ d (0~180)
    function invConvDays(r){
      if(r<=0) return 0;
      if(r<=0.01) return Math.min(9000*r, 180);
      if(r<=0.03) return Math.min(90 + 4500*(r-0.01), 180);
      return Infinity; // 180ì¼ ë‚´ ë¶ˆê°€
    }
    const DAY1_RATE=convRate(1);

    /* =======================
       DOM
    ======================= */
    const $points=document.getElementById('points');
    const $days=document.getElementById('days');
    const $daysOut=document.getElementById('daysOut');
    const $rateOut=document.getElementById('rateOut');
    const $riverUsdt=document.getElementById('riverUsdt');
    const $krwUsdt=document.getElementById('krwUsdt');
    const $riverUsdtOut=document.getElementById('riverUsdtOut');
    const $krwUsdtOut=document.getElementById('krwUsdtOut');
    const $refreshBtn=document.getElementById('refreshBtn');
    const $clearBtn=document.getElementById('clearBtn');
    const $lastUpdated=document.getElementById('lastUpdated');
    const $usdtOut=document.getElementById('usdtOut');
    const $krwOut=document.getElementById('krwOut');
    const $ratioOut=document.getElementById('ratioOut');
    const $vs1x=document.getElementById('vs1x');

    const priceUsdElement = document.getElementById('price-usd');
    const $ptPriceKrw = document.getElementById('ptPriceKrw');
    const $ptHoldingValue = document.getElementById('ptHoldingValue');
    const $ptNote = document.getElementById('ptNote');

    const riverBtn=document.getElementById('riverBtn');
    const rptsBtn=document.getElementById('rptsBtn');
    const chartFrame=document.getElementById('chartFrame');

    // ìƒˆ ì„¹ì…˜ DOM
    const $ratioNow = document.getElementById('ratioNow');
    const $breakevenOut = document.getElementById('breakevenOut');
    const $recommendOut = document.getElementById('recommendOut');
    const $ratioChart = document.getElementById('ratioChart');

    /* =======================
       ìƒíƒœ
    ======================= */
    let state={ riverUsdt:null, krwUsdt:null, rptsUsd:null };

    /* =======================
       ê³„ì‚° & ë Œë”
    ======================= */
    function recalc(){
      const pts=Number($points.value||0);
      const d=Number($days.value||0);
      const r=convRate(d);
      const riverUsdt=Number($riverUsdt.value);
      const krwUsdt=Number($krwUsdt.value);

      const usdt=pts*r*riverUsdt;
      const krw=usdt*krwUsdt;
      const ratio=DAY1_RATE?(r/DAY1_RATE):0;

      $daysOut.textContent=d.toFixed(0);
      $rateOut.textContent=r.toFixed(6);
      $vs1x.textContent=(ratio?ratio.toFixed(0):0)+"x";
      $usdtOut.textContent=fmt(usdt,4)+" USDT";
      $krwOut.textContent=fmt(krw,0)+" ì›";
      $ratioOut.textContent=ratio?ratio.toFixed(0)+"x":"-";

      renderRptsSection();
      renderRatioCompare(); // â˜… ìƒˆ ì„¹ì…˜ ì—…ë°ì´íŠ¸
    }

    function renderRptsSection(){
      const rptsUsd = Number(state.rptsUsd||0);
      const fx = Number($krwUsdt.value || state.krwUsdt || 0);
      const pts = Number($points.value||0);

      if(rptsUsd>0){
        priceUsdElement.innerHTML = `1 RIVER Pts â‰ˆ <strong>$${fmt(rptsUsd,8)}</strong>`;
        if(fx>0){
          const perKrw = rptsUsd * fx;
          $ptPriceKrw.textContent = `${fmt(perKrw,0)} ì›`;
          const totalUsd = rptsUsd * pts;
          const totalKrw = perKrw * pts;
          $ptHoldingValue.textContent = `${fmt(totalUsd,4)} USD / ${fmt(totalKrw,0)} ì›`;
        }else{
          $ptPriceKrw.textContent = "- ì›";
          $ptHoldingValue.textContent = `${fmt(rptsUsd*pts,4)} USD / - ì›`;
        }
      }else{
        priceUsdElement.textContent = "- USD";
        $ptPriceKrw.textContent = "- ì›";
        $ptHoldingValue.textContent = "- USD / - ì›";
      }
    }

    // ===== ë³€í™˜ë¥  ë¹„êµ ì„¹ì…˜ =====
    function renderRatioCompare(){
      const rptsUsd = Number(state.rptsUsd||0);
      const riverUsdt = Number(state.riverUsdt||$riverUsdt.value||0);

      if(!(rptsUsd>0 && riverUsdt>0)){
        $ratioNow.textContent = "-";
        $breakevenOut.textContent = "ì†ìµë¶„ê¸° ì¼ìˆ˜: (ê°€ê²© ë°ì´í„° ëŒ€ê¸°)";
        $recommendOut.textContent = "ì¶”ì²œ: ì‹¤ì‹œê°„ ì‹œì„¸ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ì„¸ìš”.";
        drawRatioChart(null);
        return;
      }

      // ëª©í‘œ ë³€í™˜ë¥  = (RIVERPTS ê°€ê²©) / (RIVER ê°€ê²©)
      const targetRate = rptsUsd / riverUsdt;
      $ratioNow.textContent = targetRate.toFixed(6) + " (í˜„ì¬)";

      // 180ì¼ ë‚´ ì†ìµë¶„ê¸° ì¼ìˆ˜ ê³„ì‚°
      const dNeeded = invConvDays(targetRate);
      if(!isFinite(dNeeded)){
        $breakevenOut.innerHTML = `ì†ìµë¶„ê¸° ì¼ìˆ˜: <span class="note-bad">180ì¼ ë‚´ ë„ë‹¬ ë¶ˆê°€ (ëª©í‘œ ë³€í™˜ë¥ ì´ 0.03 ì´ˆê³¼)</span>`;
        $recommendOut.textContent = "ì¶”ì²œ: ì¦‰ì‹œ ë§¤ë„(ë˜ëŠ” í¬ì¸íŠ¸ ê°€ê²© í•˜ë½/ë¦¬ë²„ ê°€ê²© ìƒìŠ¹ì„ ê¸°ë‹¤ë¦¬ê¸°)";
        drawRatioChart(targetRate);
        return;
      }

      const dInt = Math.ceil(dNeeded);
      const projRate = convRate(dInt);
      const gapPct = ((projRate - targetRate) / targetRate) * 100;

      $breakevenOut.innerHTML =
        `ì†ìµë¶„ê¸° ì¼ìˆ˜: <b>${dInt}</b>ì¼ (ê³µì‹ ë³€í™˜ë¥  ${projRate.toFixed(6)})`;

      if (gapPct >= 1) {
        $recommendOut.innerHTML = `<span class="note-ok">ì¶”ì²œ: ì•½ ${dInt}ì¼ ì´í›„ ì „í™˜ ì‹œ ìœ ë¦¬ (ëª©í‘œ ëŒ€ë¹„ +${gapPct.toFixed(1)}%)</span>`;
      } else if (gapPct >= 0) {
        $recommendOut.innerHTML = `<span class="note-warn">ì¶”ì²œ: ì•½ ${dInt}ì¼ ì´í›„ ì „í™˜ (ì†ìµë¶„ê¸° ë¶€ê·¼)</span>`;
      } else {
        $recommendOut.innerHTML = `<span class="note-bad">ì¶”ì²œ: í˜„ì¬ëŠ” ì¦‰ì‹œ ë§¤ë„ í¸ì´ ìœ ë¦¬ (ëª©í‘œ ëŒ€ë¹„ ${gapPct.toFixed(1)}%)</span>`;
      }

      drawRatioChart(targetRate, dInt);
    }

    /* ===== ë°˜ì‘í˜• ì°¨íŠ¸: ì†ìµë¶„ê¸°ì¼(dMark)ì— ë”°ë¼ ë„ˆë¹„ê°€ ì ì§„ì ìœ¼ë¡œ ì¦ê°€ ===== */
function getChartSize(wrapperEl, dMark){
  // í•„ìš”ì‹œ ì´í•˜ ê°’ë§Œ ì¡°ì ˆí•˜ë©´ UXë¥¼ ì‰½ê²Œ íŠœë‹ ê°€ëŠ¥
  const MIN_W = 400;   // ì‹œì‘ ìµœì†Œí­ (ëª¨ë°”ì¼ì—ì„œë„ ë³´ê¸° ì¢‹ì€ í¬ê¸°)
  const MAX_W = 720;   // ë°ìŠ¤í¬í†±ì—ì„œì˜ ìµœëŒ€í­ (ë„ˆë¬´ í¬ê²Œ ëŠê»´ì§€ë©´ 640/680 ë“±ìœ¼ë¡œ)
  const avail = Math.max(0, Math.floor(wrapperEl.clientWidth || 0));

  // ì»¨í…Œì´ë„ˆê°€ í—ˆìš©í•˜ëŠ” ìµœëŒ€ì¹˜(ìŠ¤í¬ë¡¤ ì—†ì´ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” í•œë„)
  const CAP = Math.max(MIN_W, Math.min(avail, MAX_W));

  // ê¸°ë³¸ì€ ìµœì†Œí­ìœ¼ë¡œ ê³ ì •
  let W = MIN_W;

  // dMarkê°€ ìœ íš¨í•´ì§€ë©´(=ê·¸ë˜í”„ê°€ ì˜¤ë¥¸ìª½ìœ¼ë¡œ "ì´ë™"í–ˆë‹¤ê³  ë³¼ ìˆ˜ ìˆì„ ë•Œ) ì ì°¨ í™•ëŒ€
  if (typeof dMark === "number" && isFinite(dMark)) {
    // 0ì¼ â†’ 0, 180ì¼ â†’ 1
    const t = Math.max(0, Math.min(1, dMark / 180));
    // ì„ í˜• ë³´ê°„: dMarkê°€ í´ìˆ˜ë¡ MIN_W â†’ MAX_Wë¡œ ë„“ì–´ì§
    const desired = MIN_W + (MAX_W - MIN_W) * t;
    W = Math.min(CAP, desired);
  }

  // ê°€ë…ì„± ìœ„í•´ í­ì— ë”°ë¼ ë†’ì´ë„ ì‚´ì§ ì¡°ì •
  const H = (W <= 480) ? 220 : 260;
  return { W, H };
}

function drawRatioChart(target=null, dMark=null){
  const svg = $ratioChart;
  const wrap = svg.parentElement; // .ratio-chart-wrap
  const { W, H } = getChartSize(wrap, dMark);

  svg.setAttribute("width", W);
  svg.setAttribute("height", H);
  svg.removeAttribute("viewBox"); // ë¹„ìœ¨ ìŠ¤ì¼€ì¼ ë°©ì§€
  svg.innerHTML = "";

  const pad = 28;
  const x0 = pad, y0 = H - pad, x1 = W - pad, y1 = pad;
  const maxX = 180, maxY = 0.03;
  const X = d=> x0 + (d/maxX)*(x1-x0);
  const Y = r=> y0 - (r/maxY)*(y0-y1);

  // ë°°ê²½ ëˆˆê¸ˆ (Y)
  for (let r=0; r<=maxY+1e-9; r+=0.005){
    const y = Y(r);
    svg.insertAdjacentHTML("beforeend", `<line x1="${x0}" y1="${y}" x2="${x1}" y2="${y}" stroke="rgba(255,255,255,.06)" />`);
    svg.insertAdjacentHTML("beforeend", `<text x="${x0-6}" y="${y+4}" fill="#9aa7b3" font-size="10" text-anchor="end">${r.toFixed(3)}</text>`);
  }
  // Xì¶• ëˆˆê¸ˆ
  for (let d=0; d<=180; d+=30){
    const x = X(d);
    svg.insertAdjacentHTML("beforeend", `<line x1="${x}" y1="${y0}" x2="${x}" y2="${y1}" stroke="rgba(255,255,255,.04)" />`);
    svg.insertAdjacentHTML("beforeend", `<text x="${x}" y="${y0+14}" fill="#9aa7b3" font-size="10" text-anchor="middle">${d}</text>`);
  }

  // ê³µì‹ ë³€í™˜ë¥  ê³¡ì„  (íŒŒë‘)
  const pathPts = [];
  for (let d=0; d<=180; d++){
    pathPts.push(`${X(d)},${Y(convRate(d))}`);
  }
  svg.insertAdjacentHTML("beforeend", `<polyline points="${pathPts.join(" ")}" fill="none" stroke="#4da3ff" stroke-width="2"/>`);

  // ëª©í‘œì„  (ì´ˆë¡)
  if (typeof target === "number"){
    const yT = Y(target);
    svg.insertAdjacentHTML("beforeend", `<line x1="${x0}" y1="${yT}" x2="${x1}" y2="${yT}" stroke="#22c55e" stroke-dasharray="6,4" stroke-width="2"/>`);
  }

  // êµì°¨ì  í‘œì‹œ
  if (typeof dMark === "number" && isFinite(dMark)){
    const xM = X(dMark), yM = Y(convRate(dMark));
    svg.insertAdjacentHTML("beforeend", `<line x1="${xM}" y1="${y0}" x2="${xM}" y2="${y1}" stroke="rgba(255,255,255,.15)" stroke-dasharray="4,4"/>`);
    svg.insertAdjacentHTML("beforeend", `<circle cx="${xM}" cy="${yM}" r="4" fill="#22c55e" stroke="#064e3b"/>`);
    svg.insertAdjacentHTML("beforeend", `<text x="${xM+6}" y="${yM-6}" fill="#22c55e" font-size="11">~${Math.ceil(dMark)}ì¼</text>`);
  }

  // ì¶•
  svg.insertAdjacentHTML("beforeend", `<line x1="${x0}" y1="${y0}" x2="${x1}" y2="${y0}" stroke="#334155"/>`);
  svg.insertAdjacentHTML("beforeend", `<line x1="${x0}" y1="${y0}" x2="${x0}" y2="${y1}" stroke="#334155"/>`);
  svg.insertAdjacentHTML("beforeend", `<text x="${x1}" y="${y0+20}" fill="#9aa7b3" font-size="10" text-anchor="end">ì¼</text>`);
  svg.insertAdjacentHTML("beforeend", `<text x="${x0-18}" y="${y1}" fill="#9aa7b3" font-size="10" text-anchor="start">ë³€í™˜ë¥ </text>`);
}

    /* =======================
       Fetchers
    ======================= */
    async function fetchRiverUsdt(){
      try{
        const j=await fetch("https://api.bitget.com/api/v2/spot/market/tickers?symbol=RIVERUSDT",{cache:"no-store"}).then(r=>r.json());
        const price=parseFloat(j?.data?.[0]?.lastPr);
        if(isFinite(price)){
          state.riverUsdt=price;
          $riverUsdt.value=String(price);
          $riverUsdtOut.textContent=`í˜„ì¬ RIVER/USDT: ${fmt(price,6)} (Bitget)`;
        } else {
          $riverUsdtOut.textContent="ìë™ ì¡°íšŒ ì‹¤íŒ¨ â€” ì§ì ‘ ì…ë ¥";
        }
      }catch(e){console.warn(e);$riverUsdtOut.textContent="ìë™ ì¡°íšŒ ì‹¤íŒ¨ â€” ì§ì ‘ ì…ë ¥";}
    }

    async function fetchKrwPerUsdt(){
      try{
        const j=await fetch("https://api.upbit.com/v1/ticker?markets=KRW-USDT",{cache:"no-store"}).then(r=>r.json());
        const price=j?.[0]?.trade_price;
        if(typeof price==="number"){
          state.krwUsdt=price;
          $krwUsdt.value=String(price);
          $krwUsdtOut.textContent=`í˜„ì¬ KRW/USDT: ${fmt(price,2)} â‚©/USDT (Upbit)`;
        } else {
          $krwUsdtOut.textContent="ìë™ ì¡°íšŒ ì‹¤íŒ¨ â€” ì§ì ‘ ì…ë ¥";
        }
      }catch(e){console.warn(e);$krwUsdtOut.textContent="ìë™ ì¡°íšŒ ì‹¤íŒ¨ â€” ì§ì ‘ ì…ë ¥";}
    }

    // GeckoTerminal: RIVERPTS USD ê°€ê²©
    async function fetchRptsUsdFromGecko(){
      try{
        const res = await fetch(GECKO_TOKEN_URL(TOKEN_RPTS), {cache:"no-store"});
        if(!res.ok) throw new Error("Gecko token api "+res.status);
        const j = await res.json();
        const usd = parseFloat(j?.data?.attributes?.price_usd);
        if(isFinite(usd)){
          state.rptsUsd = usd;
          $ptNote.textContent = "ë°ì´í„° ì¶œì²˜: GeckoTerminal(USD), Upbit(KRW/USDT)";
        }else{
          state.rptsUsd = null;
        }
      }catch(e){
        console.warn("GeckoTerminal token price ì‹¤íŒ¨:", e);
        state.rptsUsd = null;
      }
    }

    // GeckoTerminal: í† í°ì˜ ì£¼ìš” í’€ ì„ íƒ (USDT/BUSD ìš°ì„  â†’ ìœ ë™ì„± ìµœëŒ€)
    async function pickBestGeckoPool(tokenAddr){
      const res = await fetch(GECKO_POOLS_URL(tokenAddr), {cache:"no-store"});
      if(!res.ok) throw new Error("Gecko pools api "+res.status);
      const j = await res.json();
      const pools = Array.isArray(j?.data) ? j.data : [];
      if(!pools.length) throw new Error("no pools");

      const withMeta = pools.map(p => {
        const base = j?.included?.find(i => i.id === p?.relationships?.base_token?.data?.id);
        const quote = j?.included?.find(i => i.id === p?.relationships?.quote_token?.data?.id);
        return { address:p?.attributes?.address, base, quote, raw:p };
      });

      let target = withMeta.find(p => (p?.quote?.attributes?.symbol||"").toUpperCase()==="USDT")
               || withMeta.find(p => (p?.quote?.attributes?.symbol||"").toUpperCase()==="BUSD");

      if(!target){
        target = withMeta.slice().sort((a,b)=>{
          const av = Number(a?.raw?.attributes?.reserve_in_usd||0);
          const bv = Number(b?.raw?.attributes?.reserve_in_usd||0);
          return bv-av;
        })[0];
      }
      if(!target?.address) throw new Error("no pool address");
      return target.address;
    }

    async function refreshAll(){
      $lastUpdated.textContent="ì—…ë°ì´íŠ¸ ì¤‘â€¦";
      await Promise.all([fetchRiverUsdt(), fetchKrwPerUsdt(), fetchRptsUsdFromGecko()]);
      $lastUpdated.textContent="ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: "+nowStr();
      recalc();
    }

    /* =======================
       ì°¨íŠ¸ ì „í™˜ (GeckoTerminal ì„ë² ë“œ)
    ======================= */
    function setActive(on, off){ on.classList.add('active'); off.classList.remove('active'); }

    async function loadChartForToken(tokenAddr){
      try{
        const pool = await pickBestGeckoPool(tokenAddr);
        chartFrame.src = GECKO_POOL_IFRAME(pool);
      }catch(e){
        console.warn("ì°¨íŠ¸ ë¡œë“œ ì‹¤íŒ¨:", e);
        chartFrame.src = `https://www.geckoterminal.com/bsc/tokens/${tokenAddr}?embed=1`;
      }
    }

    riverBtn.onclick = ()=>{ setActive(riverBtn, rptsBtn); loadChartForToken(TOKEN_RIVER); };
    rptsBtn.onclick  = ()=>{ setActive(rptsBtn, riverBtn); loadChartForToken(TOKEN_RPTS); };

    /* =======================
       ì´ˆê¸° ì‹¤í–‰ + ë¦¬ì‚¬ì´ì¦ˆ ëŒ€ì‘
    ======================= */
    [$points,$days,$riverUsdt,$krwUsdt].forEach($el=>{
      $el.addEventListener('input', recalc);
      $el.addEventListener('change', recalc);
    });
    document.getElementById('refreshBtn').addEventListener('click', refreshAll);
    document.getElementById('clearBtn').addEventListener('click', ()=>{
      $points.value=""; $days.value=0; $riverUsdt.value=""; $krwUsdt.value="";
      $riverUsdtOut.textContent="-"; $krwUsdtOut.textContent="-"; $lastUpdated.textContent="ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -";
      recalc();
    });

    (async () => {
      await refreshAll();
      await loadChartForToken(TOKEN_RIVER);
    })();

    // ì°½ ë¦¬ì‚¬ì´ì¦ˆ/íšŒì „ì— ë§ì¶° ì°¨íŠ¸ ì¬ê·¸ë¦¬ê¸° (ë””ë°”ìš´ìŠ¤)
    let _rrf=null;
    window.addEventListener('resize', ()=>{
      if(_rrf) cancelAnimationFrame(_rrf);
      _rrf = requestAnimationFrame(()=> renderRatioCompare());
    });
    // ì»¨í…Œì´ë„ˆ ì‹¤ì œ í­ ë³€í™” ê°ì§€ (ë” ì •ë°€)
    new ResizeObserver(()=> renderRatioCompare())
      .observe(document.querySelector('.ratio-chart-wrap'));
  </script>

  <!-- â˜•ï¸ ì»¤í”¼ ë²„íŠ¼: í˜¸ë²„ ëŠê¹€ ë°©ì§€(ì§€ì—° ë‹«í˜) + ë³µì‚¬ -->
  <script>
    const WALLET_ADDRESS = "0x6D4dA73e9780FaCe848305961e49D19d310239d1";
    const coffeeWrap = document.getElementById("coffeeWrap");
    const coffeeBtn  = document.getElementById("coffeeBtn");
    const walletAddr = document.getElementById("walletAddr");
    const copyBtn    = document.getElementById("copyBtn");
    walletAddr.textContent = WALLET_ADDRESS;

    let tipOpen=false, closeTimer=null;
    function openTip(){ clearTimeout(closeTimer); tipOpen=true; coffeeWrap.classList.add("open"); coffeeBtn.setAttribute("aria-expanded","true"); }
    function closeTip(){ closeTimer=setTimeout(()=>{ tipOpen=false; coffeeWrap.classList.remove("open"); coffeeBtn.setAttribute("aria-expanded","false"); },120); }

    coffeeWrap.addEventListener("mouseenter", openTip);
    coffeeWrap.addEventListener("mouseleave", closeTip);
    coffeeBtn.addEventListener("click", (e)=>{ e.preventDefault(); tipOpen?closeTip():openTip(); });
    document.addEventListener("click", (e)=>{ if(!coffeeWrap.contains(e.target) && tipOpen) closeTip(); });

    copyBtn.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(WALLET_ADDRESS);
        const old=copyBtn.textContent; copyBtn.textContent="ë³µì‚¬ë¨!";
        setTimeout(()=>copyBtn.textContent=old,1200);
      }catch(e){
        const r=document.createRange(); r.selectNodeContents(walletAddr);
        const s=window.getSelection(); s.removeAllRanges(); s.addRange(r);
        alert("í´ë¦½ë³´ë“œ ê¶Œí•œì´ ì°¨ë‹¨ë˜ì–´ ì£¼ì†Œë¥¼ ì„ íƒí–ˆì–´ìš”. ë³µì‚¬(Ctrl/Cmd+C) í•´ì£¼ì„¸ìš”.");
      }
    });
  </script>
</body>
</html>
